name: âœ… Quality Check - No Errors Allowed!

# ğŸ¯ PURPOSE: Prevent buggy code from being merged to main branches
# This workflow MUST pass before any PR can be merged

on:
  # ğŸš¨ REQUIRED: Run on ALL pull requests (prevents bad code from merging)
  pull_request:
    branches: [ beta, main ]
  
  # Also run on beta pushes for continuous monitoring  
  push:
    branches: [ beta ]

# Only one check at a time to avoid conflicts
concurrency:
  group: quality-check-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ğŸ›¡ï¸ THE GATEKEEPER - This job prevents broken code from merging
  prevent-errors:
    name: ğŸ›¡ï¸ Error Prevention Check
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
    # ğŸ“¥ Get the code
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    # â˜• Setup Java (required for Android)
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # ğŸ¯ Setup Android SDK
    - name: ğŸ¯ Setup Android SDK
      uses: android-actions/setup-android@v3
      
    # ğŸ“¦ Speed up builds with caching
    - name: ğŸ“¦ Cache Gradle
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

    # ğŸ”§ Basic setup
    - name: ğŸ”§ Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_HOME" >> local.properties
        echo "API_BASE_URL=\"https://api-dev.wisme.com/v1/\"" >> local.properties

    # ğŸš¨ CRITICAL: Build must succeed (catches compilation errors)
    - name: ğŸš¨ Build Check (Must Pass!)
      run: |
        echo "ğŸ” Checking if code compiles without errors..."
        ./gradlew assembleDebug --stacktrace
        echo "âœ… Build successful - no compilation errors!"
      
    # ğŸ§ª CRITICAL: Tests must pass (catches logic errors)  
    - name: ğŸ§ª Test Check (Must Pass!)
      run: |
        echo "ğŸ” Running tests to catch bugs..."
        ./gradlew test --stacktrace
        echo "âœ… All tests passed - no test failures!"
      
    # ğŸ“Š IMPORTANT: Lint check (catches potential issues)
    - name: ğŸ“Š Lint Check (Must Pass!)
      run: |
        echo "ğŸ” Checking for code issues..."
        ./gradlew lintDebug --stacktrace
        echo "âœ… Lint check passed - code quality looks good!"
      
    # âœ… SUCCESS: All checks passed
    - name: âœ… All Checks Passed!
      if: success()
      run: |
        echo "ğŸ‰ GREAT JOB! Your code passed all quality checks!"
        echo "âœ… No compilation errors"
        echo "âœ… All tests passing"  
        echo "âœ… No lint issues"
        echo "ğŸš€ This PR is ready for review!"
        
    # âŒ FAILURE: Something went wrong
    - name: âŒ Quality Check Failed
      if: failure()
      run: |
        echo "ğŸš¨ QUALITY CHECK FAILED!"
        echo "âŒ Your code has errors that need to be fixed"
        echo "ğŸ“ Please check the logs above and fix the issues"
        echo "ğŸ”„ Push your fixes and this check will run again"
        exit 1

    # ğŸ’¬ Comment on PR with results
    - name: ğŸ’¬ PR Status Comment
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const status = '${{ job.status }}';
          const body = status === 'success' 
            ? 'âœ… **Quality Check PASSED!** ğŸ‰\n\nğŸ”¨ Build successful\nğŸ§ª Tests passing\nğŸ“Š Lint check passed\n\n**Ready for review!**'
            : 'âŒ **Quality Check FAILED!** ğŸš¨\n\nâš ï¸ Please fix the errors above and push again.\n\nThe PR cannot be merged until all checks pass.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });